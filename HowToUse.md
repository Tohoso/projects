# AI占いサービス 運用マニュアル

このマニュアルでは、AI占いサービスの運用方法について詳しく説明します。日常的な運用から管理機能の活用、トラブルシューティングまで、必要な情報をすべて網羅しています。

![運用フロー概要](https://placekitten.com/900/300)

## 目次

- [初期セットアップ](#初期セットアップ)
- [日常運用](#日常運用)
- [管理画面の使い方](#管理画面の使い方)
- [占いテンプレートの編集](#占いテンプレートの編集)
- [顧客対応](#顧客対応)
- [トラブルシューティング](#トラブルシューティング)
- [バックアップと復元](#バックアップと復元)
- [料金管理](#料金管理)
- [セキュリティ対策](#セキュリティ対策)
- [メンテナンス手順](#メンテナンス手順)

## 初期セットアップ

### システムの初回起動

1. サーバーにログインする
2. ターミナルで以下のコマンドを実行：
   ```bash
   cd /path/to/ai-fortune-service
   npm install
   npm start
   ```
3. ブラウザで `http://localhost:3000/admin` にアクセスし、初期設定画面を開く
4. 管理者アカウントの設定：
   - ユーザー名: `admin`（デフォルト）
   - パスワード: 安全なパスワードを設定（8文字以上、英数字記号混在）
   - メールアドレス: 管理通知を受け取るアドレス

### 外部サービスの連携確認

1. **Stores連携テスト**
   - 管理画面の「システム設定」→「外部連携」→「Stores連携テスト」をクリック
   - 「テスト決済イベント送信」ボタンをクリックし、成功メッセージを確認

2. **Claude API接続テスト**
   - 管理画面の「システム設定」→「外部連携」→「Claude API接続テスト」をクリック
   - テストプロンプトが自動送信され、レスポンスが表示されることを確認

3. **メール送信テスト**
   - 管理画面の「システム設定」→「外部連携」→「メール送信テスト」をクリック
   - テストメールアドレスを入力し、テストメールが届くことを確認

## 日常運用

### 1. サービス起動状態の確認

毎日最初に行うべきチェックポイント：

- サーバー稼働確認: `http://あなたのサイトのURL/status` にアクセスし「System Status: Running」と表示されることを確認
- スケジューラー状態確認: 管理画面の「システム状態」でスケジューラーが「稼働中」と表示されていることを確認
- エラーログチェック: 管理画面の「ログ」タブでエラーがないことを確認

### 2. 注文状況の確認

1. 管理画面の「注文管理」タブを開く
2. 以下のステータスを確認：
   - **新規注文**: フォーム送信待ち
   - **回答済み**: AI鑑定生成待ち
   - **鑑定済み**: PDF生成・メール送信待ち
   - **完了**: 全工程完了
   - **エラー**: 何らかの問題発生

3. エラー状態の注文がある場合は「詳細」をクリックして原因を確認し対処

### 3. AI鑑定結果の確認と編集

1. 管理画面の「AI鑑定管理」タブを開く
2. 「鑑定済み」の項目から確認したい顧客の鑑定結果を選択
3. 内容を確認し、必要に応じて「編集」ボタンをクリック
4. 不適切な表現や誤解を招く内容があれば修正
5. 修正後は「保存」→「PDF再生成」の順にクリック

### 4. 毎日のシステムメンテナンス

1. ストレージ容量の確認: 管理画面の「システム状態」→「ストレージ使用量」が90%未満であることを確認
2. 一時ファイルの削除: 週に1回、「システムメンテナンス」→「一時ファイル削除」をクリック
3. バックアップの確認: 「システムメンテナンス」→「バックアップ状況」で最新バックアップ日時を確認

## 管理画面の使い方

### ダッシュボード画面

![ダッシュボード画面](https://placekitten.com/800/400)

1. **概要パネル**: システム全体の状態と統計情報
   - 今日の注文数
   - 処理待ち件数
   - エラー件数
   - API使用状況

2. **最近の活動**: 直近の注文と処理状況のタイムライン

3. **クイックアクション**:
   - フォーム回答チェック: 手動で回答チェックを実行
   - AI鑑定バッチ処理: 複数の鑑定をまとめて実行
   - メール再送: エラーで送信できなかったメールを再送

### 注文管理画面

1. **フィルタリング**: 期間、ステータス、商品タイプでの絞り込み
2. **一括操作**: 複数の注文をまとめて処理
3. **詳細表示**: 個別注文の全情報とログ履歴
4. **手動介入**:
   - フォームリンク再送
   - 回答データ手動入力
   - プロセス再開

### AI鑑定管理画面

1. **鑑定結果一覧**: 生成済みのAI鑑定結果をリスト表示
2. **プレビュー**: 鑑定結果のテキスト表示とPDFプレビュー
3. **編集機能**:
   - 文言の修正
   - 段落の追加・削除
   - 運勢スコアの調整
4. **品質管理**:
   - 不適切な表現のチェック
   - 文法・表現の修正提案

### 鑑定結果の編集手順

![鑑定結果編集画面](https://placekitten.com/800/500)

1. **鑑定結果の選択**:
   - 「鑑定依頼」タブで対象の依頼を見つける
   - 「プレビュー」ボタンをクリックしてモーダルを開く

2. **内容の確認と編集**:
   - モーダルウィンドウで鑑定結果の全文を確認
   - 「編集する」ボタンをクリックして編集モードに切り替え
   - テキストエリアで自由に内容を編集
   - 以下のような観点で編集すると効果的です：
     - 不適切な表現の修正
     - 顧客の質問により特化した回答への修正
     - ポジティブな表現の強化
     - 文法や表現の改善

3. **変更の保存**:
   - 編集完了後、「保存」ボタンをクリック
   - 正常に保存されると成功メッセージが表示される

4. **PDF再生成と送信**:
   - 内容を確認後、「PDF再生成・送信」ボタンをクリック
   - PDFが自動的に再生成され、顧客にメール送信される
   - 送信完了後、依頼のステータスが「送信済み」に更新される

5. **編集履歴**:
   - 編集された鑑定結果には「管理者編集済み」マークが表示される
   - システムログに編集履歴が記録され、後から確認可能

### 編集のベストプラクティス

1. **一貫性を保つ**:
   - 文体や敬語の使い方を統一する
   - 星評価（★）の数値を大幅に変更しない

2. **専門性を維持**:
   - 占いの専門用語を適切に使用
   - 精神的なアドバイスとなる言葉遣いを心がける

3. **プライバシーへの配慮**:
   - 個人を特定できる具体的な内容は避ける
   - 機微な内容は一般化して表現する

4. **ポジティブな表現**:
   - ネガティブな予測は控えめに
   - 建設的なアドバイスを心がける

5. **緊急対応**:
   - 自傷他害のリスクを示す内容が含まれる場合は削除し、管理者に報告
   - 医療・法律・投資アドバイスに該当する内容は汎用的な表現に修正

### テンプレート管理画面

1. **プロンプトテンプレート**: Claude APIへの指示テンプレート管理
2. **メールテンプレート**: 顧客向けメールのテンプレート管理
3. **PDFテンプレート**: 生成されるPDFのデザインテンプレート管理
4. **バージョン管理**: 各テンプレートの変更履歴と復元機能

## 占いテンプレートの編集

### プロンプトテンプレートの構造

```plaintext
あなたは{{customer_name}}様の個人鑑定を行う占い師です。
生年月日は{{birth_date}}、現在のご相談内容は「{{consultation}}」です。

以下の点を踏まえて、丁寧かつ具体的な鑑定結果を提供してください：
1. 全体運: 現在から3ヶ月の運勢を5段階で評価し、詳細を説明
2. 恋愛運: 恋愛について具体的なアドバイスを提供
3. 金運: 今後の金運の傾向と注意点
4. 仕事運: キャリアに関する見通しとアドバイス
5. アドバイス: {{consultation}}に対する具体的なアドバイス

回答は必ず「鑑定結果」という見出しから始め、各項目を見出しで区切ってください。
敬語を使用し、前向きでポジティブな表現を心がけてください。
```

### テンプレート編集のポイント

1. **変数の使用**: `{{変数名}}` の形式で以下の変数を使用可能
   - `{{customer_name}}`: 顧客名
   - `{{birth_date}}`: 生年月日
   - `{{consultation}}`: 相談内容
   - `{{order_id}}`: 注文ID
   - `{{product_name}}`: 商品名

2. **運勢カテゴリ**: 以下のカテゴリを含めることを推奨
   - 全体運/総合運
   - 恋愛運
   - 金運
   - 仕事運/職場運
   - 健康運
   - 人間関係

3. **禁止事項**: 以下の内容は含めないでください
   - 医療診断や健康アドバイス
   - 投資や株式の具体的なアドバイス
   - 宗教に関する言及
   - 差別的な表現

4. **文字数目安**: 
   - 総合運: 300-400字
   - 各カテゴリ: 200-300字
   - アドバイス: 300-500字

### テンプレートのテスト方法

1. 管理画面の「テンプレート管理」→「プロンプトテンプレート」を開く
2. 編集したいテンプレートを選択して変更
3. 「テスト生成」ボタンをクリック
4. テストデータを入力（または「サンプルデータを使用」にチェック）
5. 生成結果を確認し、必要に応じて調整
6. 問題なければ「保存」をクリック

## 顧客対応

### よくある質問と回答例

1. **Q: 占い結果はいつ届きますか？**
   - A: ご入力いただいたフォームの回答から通常24時間以内にメールでお届けします。

2. **Q: フォームリンクが届きません**
   - A: 迷惑メールフォルダをご確認ください。それでも見つからない場合は、別のメールアドレスをお知らせいただければ再送いたします。

3. **Q: 占い結果の追加質問はできますか？**
   - A: 追加質問は別途「フォローアップ鑑定」として承っております。サイトから新たにご注文ください。

4. **Q: PDFが開けません**
   - A: 最新のAdobe ReaderやPDF閲覧ソフトをご利用ください。問題が続く場合は別形式でお送りすることも可能です。

### クレーム対応

1. **AI生成内容に対する不満**
   - 謝罪と共に管理画面から該当の鑑定結果を確認
   - 明らかに質の低い内容であれば「再生成」機能で新しい鑑定を作成
   - 顧客に再送信し、フォローアップメールで対応を説明

2. **遅延に対するクレーム**
   - システムログを確認し遅延原因を特定
   - 顧客に状況を説明し、完了予定時間を伝える
   - 48時間以上の遅延の場合は次回割引クーポンを提供

3. **技術的問題（ファイルが開けない等）**
   - 別形式での再送信を提案
   - リモートサポートが必要な場合は管理者に連絡

## トラブルシューティング

### システムエラーへの対応

1. **Webhook受信エラー**
   - ログを確認: `logs/webhook-error.log`
   - Stores設定で正しいWebhook URLが設定されているか確認
   - ファイアウォール設定を確認

2. **AI生成エラー**
   - Claude API接続状態を確認: 管理画面の「システム状態」→「外部API」
   - APIキーの有効期限と使用上限を確認
   - プロンプトテンプレートのエラーを確認

3. **メール送信エラー**
   - Gmail API接続状態を確認
   - 認証情報の更新が必要か確認
   - スパム対策フィルターに引っかかっていないか確認

### パフォーマンス問題

1. **システム全体が遅い**
   - サーバーリソース使用率を確認: 管理画面の「システム状態」→「リソース」
   - 不要なログファイルやテンポラリファイルを削除
   - 負荷の高いバッチ処理の実行時間を調整

2. **AI生成に時間がかかる**
   - Claude APIの負荷状況を確認
   - プロンプトの長さと複雑さを見直し
   - バッチ処理のスケジュールを調整

3. **鑑定結果編集時のトラブル対応**
   - 「保存エラー」や「編集内容が反映されない」などのトラブルに対する対処法を追加

### 復旧手順

1. **サービス停止時**
   - サーバーにSSH接続し、以下のコマンドを実行：
     ```bash
     cd /path/to/ai-fortune-service
     npm run restart
     ```
   - ログを確認: `logs/error.log`

2. **データ破損時**
   - 最新のバックアップから復元：
     ```bash
     cd /path/to/ai-fortune-service
     npm run restore -- --date=YYYY-MM-DD
     ```

3. **外部API障害時の手動対応**
   - 管理画面の「システム設定」→「メンテナンスモード」をオン
   - 処理待ちの注文を「保留」状態に変更
   - 障害が解消されたら「メンテナンスモード」をオフにし、処理を再開

## バックアップと復元

### 自動バックアップ

システムは以下のスケジュールで自動バックアップを実行します：

- **日次バックアップ**: 毎日午前3時に実行
- **週次バックアップ**: 毎週日曜日の午前4時に実行
- **月次バックアップ**: 毎月1日の午前5時に実行

バックアップファイルは `/backup` ディレクトリに保存され、以下の命名規則が使用されます：
- `daily_YYYY-MM-DD.zip`
- `weekly_YYYY-MM-DD.zip`
- `monthly_YYYY-MM.zip`

### 手動バックアップ

1. 管理画面の「システムメンテナンス」→「バックアップ」を開く
2. 「手動バックアップ実行」ボタンをクリック
3. バックアップ名（任意）とメモを入力
4. 「実行」をクリック

### 復元手順

1. 管理画面の「システムメンテナンス」→「復元」を開く
2. 復元したいバックアップファイルを選択
3. 復元オプションを選択：
   - **完全復元**: すべてのデータとシステム設定
   - **データのみ**: 顧客データと注文データのみ
   - **設定のみ**: システム設定とテンプレートのみ
4. 「復元実行」をクリックし、確認ダイアログで「はい」をクリック

## 料金管理

### API使用料のモニタリング

1. 管理画面の「料金管理」タブを開く
2. 以下の情報を確認：
   - **当月使用量**: 今月のAPI使用量と推定料金
   - **前月使用量**: 前月の確定使用量と料金
   - **日別グラフ**: 日ごとの使用量推移

3. 予算アラートの設定：
   - 「予算設定」をクリック
   - 月間予算額を入力
   - 警告しきい値（例：予算の80%）を設定

### コスト最適化

1. **プロンプト最適化**:
   - プロンプトの簡潔化でトークン数を削減
   - 不要な指示を削除

2. **バッチ処理の効率化**:
   - 類似の占いをバッチでまとめて生成
   - 低需要時間帯にバッチ処理を実行

3. **キャッシュ活用**:
   - 類似質問の回答をキャッシュから再利用
   - フォローアップ質問の際に前回データを参照

## セキュリティ対策

### データ保護

1. **個人情報の暗号化**:
   - 顧客情報はすべてAES-256で暗号化して保存
   - 復号化キーはシステム起動時のみメモリに展開

2. **アクセス制御**:
   - 管理画面へのアクセスは2要素認証を設定
   - IP制限の設定方法：管理画面の「セキュリティ設定」→「IPアクセス制限」

3. **データ保持ポリシー**:
   - 処理完了から30日経過したデータは自動的に匿名化
   - 90日経過したデータは完全削除

### セキュリティチェックリスト

毎月1回、以下のチェックを実施：

- [ ] 管理者パスワードの変更
- [ ] APIキーのローテーション
- [ ] アクセスログの異常確認
- [ ] バックアップの整合性検証
- [ ] セキュリティアップデートの適用

## メンテナンス手順

### 定期メンテナンス

毎月第1日曜日の深夜に以下の作業を実施：

1. **システムアップデート**:
   ```bash
   cd /path/to/ai-fortune-service
   git pull
   npm install
   npm run build
   ```

2. **データベースメンテナンス**:
   - 管理画面の「システムメンテナンス」→「DB最適化」を実行
   - インデックス再構築と不要データの削除

3. **ログローテーション**:
   - 1ヶ月以上前のログは圧縮してアーカイブ
   - 3ヶ月以上前のログは削除

### アップグレード手順

新バージョンへのアップグレード手順：

1. アップグレード前にフルバックアップを実行
2. メンテナンスモードをオンにする
3. 新バージョンのコードを取得：
   ```bash
   cd /path/to/ai-fortune-service
   git fetch
   git checkout v2.x.x
   ```
4. 依存関係を更新：
   ```bash
   npm install
   ```
5. マイグレーションを実行：
   ```bash
   npm run migrate
   ```
6. システムを再起動：
   ```bash
   npm run restart
   ```
7. メンテナンスモードをオフにする

## 付録

### API呼び出し制限

- **Claude API**: 1分あたり10リクエスト、1日あたり500リクエスト
- **Gmail API**: 1日あたり10,000送信
- **Google Forms API**: 1日あたり50,000リクエスト

### 重要な連絡先

- **技術サポート**: tech-support@example.com
- **Claude API サポート**: support@anthropic.com
- **Stores サポート**: support@stores.jp

### マニュアル更新履歴

- **2025-03-14**: 初版作成
- **2025-03-20**: トラブルシューティングセクション拡充
- **2025-04-05**: テンプレート編集ガイドライン追加
- **2025-04-18**: セキュリティ対策セクション更新

---

© 2025 AI占いサービス All Rights Reserved
